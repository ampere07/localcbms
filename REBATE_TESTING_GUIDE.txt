REBATE TESTING GUIDE
====================

STEP 1: VERIFY CURRENT STATE
-----------------------------
Run the diagnostic queries from REBATE_SQL_QUERIES.sql to check:
1. Does customer A0001 have technical_details record?
2. What is the current lcpnap value?
3. Does it match any rebates?

Expected findings:
- Customer exists: ✓
- Technical details exists: ? (check this)
- lcpnap matches rebate: ? (check this)


STEP 2: SET UP TEST DATA
-------------------------
If technical_details is missing or lcpnap doesn't match:

1. Find the rebate's selected_rebate value:
   SELECT selected_rebate FROM rebates WHERE status = 'Unused' LIMIT 1;
   
   Example result: "LCP-001 to NAP-001"

2. Update the customer's technical details to match:
   UPDATE technical_details td
   JOIN billing_accounts ba ON ba.id = td.account_id
   SET td.lcpnap = 'LCP-001 to NAP-001'  -- USE THE VALUE FROM STEP 1
   WHERE ba.account_no = 'A0001';


STEP 3: GENERATE INVOICE
-------------------------
1. Go to SOA Generation page
2. Click "Force Generate All"
3. Wait for generation to complete


STEP 4: CHECK LOGS
-------------------
Open: storage/logs/laravel.log

Look for these log entries (in order):

1. "Calculating rebates"
   - Should show customer_lcpnap value
   - Should show total_rebates_available > 0

2. "Rebate matched and applied"
   - Should show rebate_id
   - Should show rebate_type: "lcpnap"
   - Should show rebate_days: 2
   - Should show rebate_value: (calculated amount)

3. "Total rebates calculated"
   - Should show total_rebate_amount > 0

4. "Marking rebates as used"
   - Should show rebates being marked as Used

Example log output:
[2025-11-24 14:16:29] local.INFO: Calculating rebates {"account_no":"A0001","total_rebates_available":1,"customer_lcpnap":"LCP-001 to NAP-001"...}
[2025-11-24 14:16:29] local.INFO: Rebate matched and applied {"rebate_id":1,"account_no":"A0001","rebate_type":"lcpnap","selected_rebate":"LCP-001 to NAP-001","rebate_days":2,"daily_rate":43.3,"rebate_value":86.6}
[2025-11-24 14:16:29] local.INFO: Total rebates calculated {"account_no":"A0001","total_rebate_amount":86.6}
[2025-11-24 14:16:29] local.INFO: Marking rebates as used after invoice generation {"account_no":"A0001","rebates_count":1,"invoice_id":"251124000000"}


STEP 5: VERIFY RESULTS
-----------------------
1. Check invoice amounts:
   SELECT invoice_balance, others_and_basic_charges, total_amount 
   FROM invoices 
   WHERE account_no = 'A0001' 
   ORDER BY id DESC 
   LIMIT 1;
   
   Expected:
   - others_and_basic_charges should be REDUCED by rebate amount
   - If rebate_days = 2, daily rate = ₱43.30, reduction = ₱86.60

2. Check rebate status:
   SELECT status, modified_date 
   FROM rebates 
   WHERE id = 1;
   
   Expected:
   - status: "Used"
   - modified_date: (recent timestamp)

3. Check SOA:
   SELECT 
       statement_date,
       monthly_service_fee,
       others_and_basic_charges,
       vat,
       amount_due,
       total_amount_due
   FROM statement_of_accounts 
   WHERE account_no = 'A0001' 
   ORDER BY id DESC 
   LIMIT 1;
   
   Expected:
   - others_and_basic_charges should reflect rebate deduction


STEP 6: VERIFY CALCULATION
---------------------------
Manual calculation to verify:

Given:
- Monthly Fee: ₱1,299.00
- Days in November: 30
- Rebate Days: 2

Calculation:
Daily Rate = ₱1,299.00 ÷ 30 = ₱43.30
Rebate Amount = ₱43.30 × 2 = ₱86.60

Expected Invoice Impact:
Before rebate: others_and_basic_charges = ₱1,598.00 (staggered) + ₱0 (service fees) - ₱100 (discount) = ₱1,498.00
After rebate:  others_and_basic_charges = ₱1,598.00 (staggered) + ₱0 (service fees) - ₱100 (discount) - ₱86.60 (rebate) = ₱1,411.40

Total Invoice:
invoice_balance: ₱1,299.00 (monthly fee)
others_and_basic_charges: ₱1,411.40
total_amount: ₱2,710.40


TROUBLESHOOTING
---------------

Problem: No log entry "Calculating rebates"
Solution: 
- Check if technicalDetails relationship is loaded
- Verify calculateRebates() is being called
- Check if account has customer relationship

Problem: Log shows "No technical details found"
Solution:
- Run INSERT query from REBATE_SQL_QUERIES.sql
- Ensure account has technical_details record

Problem: Log shows "Calculating rebates" but no "Rebate matched"
Solution:
- Verify exact string match: customer lcpnap vs rebate selected_rebate
- Check for extra spaces, case sensitivity
- Run verification query (#4) from REBATE_SQL_QUERIES.sql

Problem: Rebate matched but amount is wrong
Solution:
- Verify number_of_dates in rebates table
- Check monthly fee from plan_list table
- Verify days in current month
- Compare with manual calculation

Problem: Rebate not marked as "Used"
Solution:
- Check if markRebatesAsUsed() is being called
- Verify rebate status before generation
- Check logs for "Marking rebates as used" message


EXPECTED BEHAVIOR SUMMARY
--------------------------
✓ Rebate matches customer's lcpnap value
✓ Rebate amount calculated correctly (daily_rate × rebate_days)
✓ Rebate appears in logs with calculation details
✓ others_and_basic_charges reduced by rebate amount
✓ Rebate status changes from "Unused" to "Used"
✓ modified_date updated on rebate record
✓ Invoice total_amount reflects rebate deduction
